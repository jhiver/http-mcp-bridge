{% extends "base_authenticated.html" %}

{% block title %}Add Tool - SaraMCP{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/toolkits">My Toolkits</a> /
    <a href="/toolkits/{{ toolkit_id }}">{{ toolkit_title }}</a> /
    New Tool
</div>

<div class="page-header">
    <h1>Create New Tool</h1>
    <a href="/toolkits/{{ toolkit_id }}" class="btn btn-small">Back to Toolkit</a>
</div>

{% if let Some(err) = error %}
<div class="error">{{ err }}</div>
{% endif %}

<form method="post" action="/toolkits/{{ toolkit_id }}/tools" class="form-card">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <fieldset>
        <legend>Tool Information</legend>

        <div class="form-group">
            <label for="name">Tool Name *</label>
            <input
                type="text"
                id="name"
                name="name"
                required
                maxlength="100"
                placeholder="e.g., Customer Lookup">
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea
                id="description"
                name="description"
                rows="3"
                placeholder="What does this tool do?"></textarea>
        </div>
    </fieldset>

    <fieldset>
        <legend>HTTP Request Configuration</legend>

        <div class="form-group">
            <label for="method">HTTP Method & URL *</label>
            <div class="method-url-row">
                <select name="method" id="method" required>
                    <option value="GET" selected>GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <input
                    type="text"
                    name="url"
                    id="url"
                    required
                    placeholder="https://api.example.com/users/{% raw %}{{integer:user_id}}{% endraw %}">
            </div>
            <small>Use {% raw %}{{type:name}}{% endraw %} for parameters. Types: string, integer, number, boolean</small>
        </div>

        <div class="form-group">
            <label for="headers">Headers (JSON format)</label>
            <textarea
                id="headers"
                name="headers"
                rows="4"
                placeholder='{"Authorization": "Bearer {% raw %}{{string:token}}{% endraw %}", "Content-Type": "application/json"}'
                style="font-family: monospace">{}</textarea>
        </div>

        <div class="form-group" id="body-section" style="display: none">
            <label for="body">Request Body (JSON format)</label>
            <textarea
                id="body"
                name="body"
                rows="6"
                placeholder='{"name": "{% raw %}{{string:name}}{% endraw %}", "active": {% raw %}{{boolean:is_active}}{% endraw %}}'
                style="font-family: monospace"></textarea>
        </div>

        <div class="form-group">
            <label for="timeout_ms">Timeout (milliseconds) *</label>
            <input
                type="number"
                id="timeout_ms"
                name="timeout_ms"
                value="30000"
                min="1000"
                max="120000"
                step="1000"
                required>
        </div>
    </fieldset>

    <fieldset id="detected-params" style="display: none">
        <legend>Detected Parameters</legend>
        <div id="parameters-list" class="params-display">
            <p>Parameters will be automatically detected from your URL, headers, and body templates.</p>
            <ul id="params-found"></ul>
        </div>
    </fieldset>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Tool</button>
        <a href="/toolkits/{{ toolkit_id }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Progressive enhancement - works without JS but better with it
document.addEventListener('DOMContentLoaded', function() {
    const methodSelect = document.getElementById('method');
    const bodySection = document.getElementById('body-section');
    const urlInput = document.getElementById('url');
    const headersInput = document.getElementById('headers');
    const bodyInput = document.getElementById('body');
    const detectedParams = document.getElementById('detected-params');
    const paramsList = document.getElementById('params-found');

    // Show/hide body section based on method
    function toggleBodySection() {
        const method = methodSelect.value;
        if (['POST', 'PUT', 'PATCH'].includes(method)) {
            bodySection.style.display = 'block';
        } else {
            bodySection.style.display = 'none';
        }
    }

    // Extract parameters from templates
    function extractParameters() {
        // Updated regex to support both formats
        const paramRegex = /\{\{(?:(\w+):)?(\w+)\}\}/g;
        const params = new Map();

        // Extract from URL
        const url = urlInput.value;
        let match;
        while ((match = paramRegex.exec(url)) !== null) {
            const type = match[1] || 'string'; // Default to string if no type specified
            const name = match[2];
            params.set(name, { type: type, name: name, source: 'URL', pattern: match[0] });
        }

        // Extract from headers
        const headers = headersInput.value;
        paramRegex.lastIndex = 0; // Reset regex state
        while ((match = paramRegex.exec(headers)) !== null) {
            const type = match[1] || 'string'; // Default to string if no type specified
            const name = match[2];
            if (!params.has(name)) {
                params.set(name, { type: type, name: name, source: 'Headers', pattern: match[0] });
            }
        }

        // Extract from body (if visible)
        if (bodySection.style.display !== 'none') {
            const body = bodyInput.value;
            paramRegex.lastIndex = 0; // Reset regex state
            while ((match = paramRegex.exec(body)) !== null) {
                const type = match[1] || 'string'; // Default to string if no type specified
                const name = match[2];
                if (!params.has(name)) {
                    params.set(name, { type: type, name: name, source: 'Body', pattern: match[0] });
                }
            }
        }

        // Update display
        if (params.size > 0) {
            detectedParams.style.display = 'block';
            paramsList.innerHTML = Array.from(params.values())
                .map(p => `<li><code>${p.pattern}</code> (type: ${p.type}) - Found in ${p.source}</li>`)
                .join('');
        } else {
            detectedParams.style.display = 'none';
        }
    }

    // Event listeners
    methodSelect.addEventListener('change', function() {
        toggleBodySection();
        extractParameters();
    });

    urlInput.addEventListener('input', extractParameters);
    headersInput.addEventListener('input', extractParameters);
    bodyInput.addEventListener('input', extractParameters);

    // Initial setup
    toggleBodySection();
    extractParameters();
});
</script>

<!-- Fallback for no-JS -->
<noscript>
    <style>
        #body-section { display: block !important; }
        #detected-params { display: block !important; }
    </style>
</noscript>
{% endblock %}